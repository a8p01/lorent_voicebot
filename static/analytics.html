<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lorent Analytics Dashboard - Enhanced</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root {
            --primary-black: #1a1a1a;
            --soft-black: #2c2c2c;
            --pure-white: #ffffff;
            --gold-accent: #d4af37;
            --light-gray: #f8f8f8;
            --border-gray: #e8e8e8;
            --deep-navy: #0f1419;
            --warm-gold: #daa520;
            --success-green: #27ae60;
            --info-blue: #3498db;
            --warning-orange: #f39c12;
            --danger-red: #e74c3c;
            
            --font-primary: 'Playfair Display', serif;
            --font-secondary: 'Inter', sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-secondary);
            background: var(--primary-black);
            min-height: 100vh;
            color: var(--soft-black);
            line-height: 1.6;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .dashboard-header {
            background: linear-gradient(135deg, var(--deep-navy), var(--primary-black));
            border: 2px solid var(--gold-accent);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(212, 175, 55, 0.2);
            position: relative;
        }

        .dashboard-header h1 {
            font-family: var(--font-primary);
            font-size: 2.5rem;
            font-weight: 600;
            color: var(--pure-white);
            margin-bottom: 8px;
            letter-spacing: 2px;
        }

        .dashboard-header p {
            color: rgba(255, 255, 255, 0.85);
            font-size: 1.1rem;
            font-style: italic;
        }

        .live-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.1);
            padding: 6px 12px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .live-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success-green);
            animation: pulse 2s infinite;
        }

        .live-text {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.8rem;
            font-weight: 500;
        }

        /* Enhanced Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.98);
            border: 1px solid var(--gold-accent);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.15);
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--gold-accent), var(--warm-gold));
            transition: left 0.5s ease;
        }

        .metric-card:hover::before {
            left: 0;
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(212, 175, 55, 0.25);
        }

        .metric-number {
            font-family: var(--font-primary);
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--soft-black);
            margin-bottom: 8px;
        }

        .metric-label {
            color: var(--soft-black);
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 5px;
        }

        .metric-sub {
            color: #666;
            font-size: 0.8rem;
        }

        .metric-trend {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 12px;
            margin-top: 8px;
        }

        .trend-up {
            background: rgba(39, 174, 96, 0.1);
            color: var(--success-green);
        }

        .trend-down {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger-red);
        }

        /* Enhanced Insights Section */
        .insights-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .insight-card {
            background: rgba(255, 255, 255, 0.98);
            border: 1px solid var(--gold-accent);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.15);
            transition: all 0.3s ease;
        }

        .insight-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(212, 175, 55, 0.2);
        }

        .insight-title {
            font-family: var(--font-primary);
            font-size: 1.3rem;
            color: var(--soft-black);
            margin-bottom: 20px;
            border-bottom: 2px solid var(--gold-accent);
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Enhanced Emotions Card */
        .emotions-card {
            background: linear-gradient(135deg, var(--deep-navy), var(--primary-black));
            color: var(--pure-white);
            border: 2px solid var(--gold-accent);
        }

        .emotions-card .insight-title {
            color: var(--pure-white);
            border-bottom-color: var(--gold-accent);
        }

        .emotion-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .emotion-item:last-child {
            border-bottom: none;
        }

        .emotion-bar {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: linear-gradient(90deg, rgba(212, 175, 55, 0.3), rgba(218, 165, 32, 0.1));
            border-radius: 4px;
            transition: width 0.8s ease;
        }

        .emotion-content {
            position: relative;
            z-index: 2;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .emotion-name {
            font-weight: 600;
            color: var(--gold-accent);
        }

        .emotion-score {
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* Chart containers */
        .chart-container {
            height: 300px;
            margin-top: 20px;
            position: relative;
        }

        .chart-small {
            height: 200px;
        }

        /* Enhanced Watch Analysis */
        .watch-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-gray);
            transition: all 0.3s ease;
            position: relative;
        }

        .watch-item:last-child {
            border-bottom: none;
        }

        .watch-item:hover {
            background: rgba(212, 175, 55, 0.1);
            margin: 0 -15px;
            padding-left: 15px;
            padding-right: 15px;
            border-radius: 8px;
        }

        .watch-name {
            font-weight: 600;
            color: var(--soft-black);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .watch-count {
            background: linear-gradient(135deg, var(--gold-accent), var(--warm-gold));
            color: var(--primary-black);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .watch-engagement {
            font-size: 0.75rem;
            color: #666;
            margin-left: 8px;
        }

        /* Emotional Journey Section */
        .emotional-journey {
            background: rgba(255, 255, 255, 0.98);
            border: 1px solid var(--gold-accent);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.15);
        }

        /* Session Quality Metrics */
        .quality-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .quality-item {
            background: var(--light-gray);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid var(--gold-accent);
        }

        .quality-value {
            font-family: var(--font-primary);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--soft-black);
        }

        .quality-label {
            font-size: 0.85rem;
            color: #666;
            margin-top: 4px;
        }

        /* Enhanced Conversations Section */
        .conversations-section {
            background: rgba(255, 255, 255, 0.98);
            border: 1px solid var(--gold-accent);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.15);
        }

        .section-title {
            font-family: var(--font-primary);
            font-size: 1.5rem;
            color: var(--soft-black);
            margin-bottom: 20px;
            border-bottom: 2px solid var(--gold-accent);
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filters {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px;
            background: var(--light-gray);
            border-radius: 10px;
            border: 1px solid var(--border-gray);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-weight: 600;
            color: var(--soft-black);
            font-size: 0.9rem;
        }

        .filter-group input, .filter-group select {
            padding: 8px 12px;
            border: 1px solid var(--border-gray);
            border-radius: 6px;
            font-size: 0.9rem;
            background: var(--pure-white);
            transition: all 0.3s ease;
        }

        .filter-group input:focus, .filter-group select:focus {
            outline: none;
            border-color: var(--gold-accent);
            box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2);
        }

        .btn {
            background: linear-gradient(135deg, var(--gold-accent), var(--warm-gold));
            color: var(--primary-black);
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--soft-black), var(--primary-black));
            color: var(--pure-white);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, var(--primary-black), #000);
        }

        /* Enhanced Table */
        .conversation-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .conversation-table th {
            background: linear-gradient(135deg, var(--deep-navy), var(--primary-black));
            color: var(--pure-white);
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .conversation-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border-gray);
            font-size: 0.85rem;
        }

        .conversation-table tr:nth-child(even) {
            background: var(--light-gray);
        }

        .conversation-table tr:hover {
            background: rgba(212, 175, 55, 0.1);
        }

        .message-type {
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .user-message {
            background: linear-gradient(135deg, var(--gold-accent), var(--warm-gold));
            color: var(--primary-black);
        }

        .assistant-message {
            background: linear-gradient(135deg, var(--soft-black), var(--primary-black));
            color: var(--pure-white);
        }

        .emotion-indicator {
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: 600;
            background: rgba(212, 175, 55, 0.1);
            color: var(--soft-black);
            border: 1px solid rgba(212, 175, 55, 0.3);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        .error {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: var(--pure-white);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 600;
            text-align: center;
        }

        /* Stats Summary */
        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            background: var(--light-gray);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-family: var(--font-primary);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--soft-black);
        }

        .stat-desc {
            color: #666;
            font-size: 0.85rem;
            margin-top: 2px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .dashboard-header h1 {
                font-size: 2rem;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .insights-section {
                grid-template-columns: 1fr;
            }
            
            .filters {
                flex-direction: column;
                align-items: stretch;
            }
            
            .conversation-table {
                font-size: 0.75rem;
            }
            
            .conversation-table th, .conversation-table td {
                padding: 8px 6px;
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <div class="dashboard-header">
            <div class="live-indicator">
                <div class="live-dot"></div>
                <span class="live-text">LIVE</span>
            </div>
            <h1>LORENT</h1>
            <p>Luxury Watch Analytics & Customer Emotional Intelligence</p>
        </div>

        <!-- Enhanced Key Metrics -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-number" id="totalSessions">-</div>
                <div class="metric-label">Total Sessions</div>
                <div class="metric-sub" id="avgSessionTime">Loading...</div>
                <div class="metric-trend trend-up" id="sessionTrend" style="display: none;">
                    <span>‚Üó</span> +12% vs yesterday
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-number" id="emotionalSessions">-</div>
                <div class="metric-label">Sessions with Emotions</div>
                <div class="metric-sub" id="emotionCoverage">Loading...</div>
                <div class="metric-trend trend-up" id="emotionTrend" style="display: none;">
                    <span>‚Üó</span> High engagement
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-number" id="avgContemplation">-</div>
                <div class="metric-label">Avg Contemplation Score</div>
                <div class="metric-sub" id="contemplationDesc">Loading...</div>
                <div class="metric-trend trend-up" id="contemplationTrend" style="display: none;">
                    <span>‚Üó</span> Users thinking deeply
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-number" id="totalConversations">-</div>
                <div class="metric-label">Total Messages</div>
                <div class="metric-sub" id="avgPerSession">Loading...</div>
                <div class="metric-trend" id="messageTrend" style="display: none;">
                    <span>‚Üí</span> Steady engagement
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-number" id="uniqueWatches">-</div>
                <div class="metric-label">Unique Watches Shown</div>
                <div class="metric-sub" id="totalWatchViews">Loading...</div>
            </div>
            <div class="metric-card">
                <div class="metric-number" id="engagementRate">-</div>
                <div class="metric-label">Emotional Engagement</div>
                <div class="metric-sub" id="engagementDesc">Loading...</div>
            </div>
        </div>

        <!-- Enhanced Insights Section -->
        <div class="insights-section">
            <!-- Top Emotions with Bar Chart -->
            <div class="insight-card emotions-card">
                <h3 class="insight-title">üé≠ Customer Emotional Profile</h3>
                <div id="topEmotions">
                    <div class="loading">Loading emotional analysis...</div>
                </div>
                <div class="chart-container chart-small">
                    <canvas id="emotionsChart"></canvas>
                </div>
            </div>

            <!-- Popular Watches with Engagement -->
            <div class="insight-card">
                <h3 class="insight-title">‚åö Watch Model Performance</h3>
                <div id="popularWatches">
                    <div class="loading">Loading watch analytics...</div>
                </div>
            </div>

            <!-- Session Quality Metrics -->
            <div class="insight-card">
                <h3 class="insight-title">üìä Session Quality Insights</h3>
                <div class="quality-metrics" id="qualityMetrics">
                    <div class="quality-item">
                        <div class="quality-value" id="avgDuration">-</div>
                        <div class="quality-label">Avg Duration (min)</div>
                    </div>
                    <div class="quality-item">
                        <div class="quality-value" id="completionRate">-</div>
                        <div class="quality-label">Completion Rate</div>
                    </div>
                    <div class="quality-item">
                        <div class="quality-value" id="emotionalDepth">-</div>
                        <div class="quality-label">Emotional Depth</div>
                    </div>
                    <div class="quality-item">
                        <div class="quality-value" id="interactionQuality">-</div>
                        <div class="quality-label">Interaction Quality</div>
                    </div>
                </div>
            </div>

            <!-- Temporal Patterns -->
            <div class="insight-card">
                <h3 class="insight-title">‚è∞ Temporal Emotional Patterns</h3>
                <div class="chart-container chart-small">
                    <canvas id="temporalChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Emotional Journey Timeline -->
        <div class="emotional-journey">
            <h2 class="section-title">üåä Emotional Journey Analysis</h2>
            <div class="chart-container">
                <canvas id="emotionalJourneyChart"></canvas>
            </div>
        </div>

        <!-- Enhanced Conversations Section -->
        <div class="conversations-section">
            <h2 class="section-title">üí¨ Conversation Deep Dive</h2>
            
            <!-- Summary Stats -->
            <div class="stats-summary" id="conversationStats">
                <div class="stat-item">
                    <div class="stat-value" id="filteredCount">-</div>
                    <div class="stat-desc">Total Messages</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="uniqueSessions">-</div>
                    <div class="stat-desc">Unique Sessions</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="avgWordsPerMsg">-</div>
                    <div class="stat-desc">Avg Words/Message</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="emotionalMessages">-</div>
                    <div class="stat-desc">With Emotions</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="avgEmotionIntensity">-</div>
                    <div class="stat-desc">Avg Emotion Intensity</div>
                </div>
            </div>

            <!-- Filters -->
            <div class="filters">
                <div class="filter-group">
                    <label>üìÖ Date Filter:</label>
                    <select id="dateFilter">
                        <option value="all">All Time</option>
                        <option value="today">Today</option>
                        <option value="yesterday">Yesterday</option>
                        <option value="week">Last 7 Days</option>
                        <option value="month">Last 30 Days</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>üí¨ Message Type:</label>
                    <select id="messageTypeFilter">
                        <option value="all">All Messages</option>
                        <option value="user">User Only</option>
                        <option value="assistant">Assistant Only</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>üé≠ Emotion Filter:</label>
                    <select id="emotionFilter">
                        <option value="all">All Emotions</option>
                        <option value="high_contemplation">High Contemplation</option>
                        <option value="high_interest">High Interest</option>
                        <option value="high_satisfaction">High Satisfaction</option>
                        <option value="any_emotion">Any Emotion Present</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>üîß Session ID:</label>
                    <input type="text" id="sessionIdFilter" placeholder="Filter by session...">
                </div>
                <div class="filter-group">
                    <label>üìè Limit:</label>
                    <select id="limitFilter">
                        <option value="50">50 Messages</option>
                        <option value="100" selected>100 Messages</option>
                        <option value="200">200 Messages</option>
                        <option value="500">500 Messages</option>
                    </select>
                </div>
                <button class="btn" onclick="loadConversations()">üîç Apply Filters</button>
                <button class="btn btn-secondary" onclick="exportData()">üìä Export CSV</button>
                <button class="btn btn-secondary" onclick="exportEmotionalData()">üé≠ Export Emotions</button>
            </div>

            <!-- Conversation Table -->
            <div id="conversationContent">
                <div class="loading">Loading conversations...</div>
            </div>
        </div>
    </div>

    <script>
        let currentData = [];
        let currentSessions = [];
        let emotionsChart = null;
        let temporalChart = null;
        let emotionalJourneyChart = null;

        // Initialize dashboard
        window.addEventListener('DOMContentLoaded', () => {
            loadDashboardData();
            loadConversations();
            
            // Auto-refresh every 30 seconds
            setInterval(loadDashboardData, 30000);
        });

        async function loadDashboardData() {
            try {
                // Load analytics data
                const analyticsResponse = await fetch('/api/analytics');
                const analytics = await analyticsResponse.json();
                
                if (analytics.error) throw new Error(analytics.error);

                // Load sessions data with emotional analysis
                const sessionsResponse = await fetch('/api/sessions?include_emotions=true');
                const sessionsData = await sessionsResponse.json();
                
                if (sessionsData.error) throw new Error(sessionsData.error);
                
                currentSessions = sessionsData.sessions;

                // Update enhanced metrics
                updateEnhancedMetrics(analytics, currentSessions);
                
                // Process and display emotional data
                const emotionalAnalysis = processEmotionalData(currentSessions);
                updateEmotionalInsights(emotionalAnalysis);
                
                // Update other sections
                updatePopularWatches(analytics.popular_watches, currentSessions);
                updateQualityMetrics(currentSessions);
                updateTemporalPatterns(currentSessions);
                updateEmotionalJourney(currentSessions);

            } catch (error) {
                console.error('Error loading dashboard data:', error);
                // Show error in UI
                document.querySelector('.metrics-grid').innerHTML = 
                    `<div class="error">‚ö†Ô∏è Error loading data: ${error.message}</div>`;
            }
        }

        function processEmotionalData(sessions) {
            const emotionTotals = {};
            const emotionCounts = {};
            let totalEmotionalSessions = 0;
            let totalEmotionalMessages = 0;
            const sessionsWithEmotions = [];
            
            sessions.forEach(session => {
                if (session.emotions_processed && session.emotion_summary && session.emotion_summary.average_emotions) {
                    totalEmotionalSessions++;
                    const avgEmotions = session.emotion_summary.average_emotions;
                    
                    // Store session-level data
                    sessionsWithEmotions.push({
                        session_id: session.session_id,
                        start_time: session.start_time,
                        duration: session.duration_seconds,
                        total_messages: session.total_messages,
                        emotional_messages: session.total_emotional_messages || 0,
                        emotions: avgEmotions,
                        top_emotions: session.emotion_summary.top_emotions || {}
                    });
                    
                    totalEmotionalMessages += session.total_emotional_messages || 0;
                    
                    // Aggregate emotions
                    Object.entries(avgEmotions).forEach(([emotion, score]) => {
                        if (!emotionTotals[emotion]) {
                            emotionTotals[emotion] = 0;
                            emotionCounts[emotion] = 0;
                        }
                        emotionTotals[emotion] += score;
                        emotionCounts[emotion]++;
                    });
                }
            });
            
            // Calculate averages
            const emotionAverages = {};
            Object.keys(emotionTotals).forEach(emotion => {
                emotionAverages[emotion] = emotionTotals[emotion] / emotionCounts[emotion];
            });
            
            // Sort emotions by intensity
            const topEmotions = Object.entries(emotionAverages)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);
            
            return {
                totalEmotionalSessions,
                totalEmotionalMessages,
                emotionAverages,
                topEmotions,
                sessionsWithEmotions,
                coverageRate: sessions.length > 0 ? (totalEmotionalSessions / sessions.length) * 100 : 0
            };
        }

        function updateEnhancedMetrics(analytics, sessions) {
            const emotionalAnalysis = processEmotionalData(sessions);
            
            // Total sessions
            document.getElementById('totalSessions').textContent = analytics.total_sessions || sessions.length || 0;
            
            // Average session time
            const avgDuration = analytics.avg_session_duration || 0;
            const avgMinutes = Math.floor(avgDuration / 60);
            const avgSeconds = Math.round(avgDuration % 60);
            document.getElementById('avgSessionTime').textContent = 
                avgDuration > 0 ? `${avgMinutes}m ${avgSeconds}s avg` : 'No completed sessions';

            // Emotional sessions
            document.getElementById('emotionalSessions').textContent = emotionalAnalysis.totalEmotionalSessions;
            document.getElementById('emotionCoverage').textContent = 
                `${emotionalAnalysis.coverageRate.toFixed(1)}% coverage`;

            // Contemplation score (key emotion from your analysis)
            const contemplationScore = emotionalAnalysis.emotionAverages['Contemplation'] || 0;
            document.getElementById('avgContemplation').textContent = 
                (contemplationScore * 100).toFixed(1) + '%';
            document.getElementById('contemplationDesc').textContent = 
                contemplationScore > 0.15 ? 'Deep thinking mode' : 'Light engagement';

            // Total conversations
            document.getElementById('totalConversations').textContent = analytics.total_messages || 0;
            
            // Messages per session
            const avgPerSession = analytics.total_sessions > 0 ? 
                (analytics.total_messages / analytics.total_sessions).toFixed(1) : '0';
            document.getElementById('avgPerSession').textContent = `${avgPerSession} per session`;

            // Unique watches
            document.getElementById('uniqueWatches').textContent = analytics.unique_watches_shown || 0;
            
            // Total watch views
            document.getElementById('totalWatchViews').textContent = 
                `${analytics.total_watch_displays || 0} total views`;

            // Emotional engagement rate
            const emotionalEngagement = emotionalAnalysis.totalEmotionalMessages > 0 && analytics.total_messages > 0 ? 
                ((emotionalAnalysis.totalEmotionalMessages / analytics.total_messages) * 100).toFixed(1) : '0';
            document.getElementById('engagementRate').textContent = `${emotionalEngagement}%`;
            document.getElementById('engagementDesc').textContent = 'Messages with emotions';
        }

        function updateEmotionalInsights(emotionalAnalysis) {
            const container = document.getElementById('topEmotions');
            
            if (!emotionalAnalysis || emotionalAnalysis.topEmotions.length === 0) {
                container.innerHTML = `
                    <div class="loading">No emotional data yet</div>
                    <p style="text-align: center; margin-top: 15px; color: rgba(255,255,255,0.7); font-size: 0.85rem;">
                        Emotions will appear as customers interact
                    </p>
                `;
                return;
            }

            // Create emotion bars
            const maxScore = emotionalAnalysis.topEmotions[0][1];
            let html = emotionalAnalysis.topEmotions.slice(0, 6).map(([emotion, score]) => {
                const percentage = (score / maxScore) * 100;
                return `
                    <div class="emotion-item">
                        <div class="emotion-bar" style="width: ${percentage}%"></div>
                        <div class="emotion-content">
                            <span class="emotion-name">${emotion}</span>
                            <span class="emotion-score">${(score * 100).toFixed(1)}%</span>
                        </div>
                    </div>
                `;
            }).join('');

            // Add summary
            html += `
                <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; border: 1px solid rgba(212,175,55,0.2);">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: center;">
                        <div>
                            <div style="font-size: 1.2rem; font-weight: 700; color: var(--gold-accent);">${emotionalAnalysis.totalEmotionalSessions}</div>
                            <div style="font-size: 0.85rem; color: rgba(255,255,255,0.8);">Sessions analyzed</div>
                        </div>
                        <div>
                            <div style="font-size: 1.2rem; font-weight: 700; color: var(--gold-accent);">${emotionalAnalysis.totalEmotionalMessages}</div>
                            <div style="font-size: 0.85rem; color: rgba(255,255,255,0.8);">Emotional messages</div>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = html;

            // Update emotions chart
            updateEmotionsChart(emotionalAnalysis.topEmotions.slice(0, 6));
        }

        function updateEmotionsChart(topEmotions) {
            const ctx = document.getElementById('emotionsChart').getContext('2d');
            
            if (emotionsChart) {
                emotionsChart.destroy();
            }

            emotionsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: topEmotions.map(([emotion]) => emotion),
                    datasets: [{
                        data: topEmotions.map(([, score]) => (score * 100).toFixed(1)),
                        backgroundColor: [
                            '#d4af37',
                            '#daa520',
                            '#b8860b',
                            '#cd853f',
                            '#d2691e',
                            '#deb887'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function updatePopularWatches(watches, sessions) {
            const container = document.getElementById('popularWatches');
            
            if (!watches || watches.length === 0) {
                container.innerHTML = '<div class="loading">No watch data yet</div>';
                return;
            }

            // Calculate engagement for each watch
            const watchEngagement = {};
            sessions.forEach(session => {
                if (session.watch_models_shown && session.emotions_processed) {
                    session.watch_models_shown.forEach(model => {
                        if (!watchEngagement[model]) {
                            watchEngagement[model] = { emotional_sessions: 0, total_sessions: 0 };
                        }
                        watchEngagement[model].total_sessions++;
                        if (session.total_emotional_messages > 0) {
                            watchEngagement[model].emotional_sessions++;
                        }
                    });
                }
            });

            const html = watches.slice(0, 6).map((watch, index) => {
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '‚åö';
                const engagement = watchEngagement[watch.model];
                const engagementRate = engagement ? 
                    ((engagement.emotional_sessions / engagement.total_sessions) * 100).toFixed(0) : '0';
                
                return `
                    <div class="watch-item">
                        <div class="watch-name">
                            ${medal} ${watch.model}
                            <span class="watch-engagement">${engagementRate}% emotional</span>
                        </div>
                        <span class="watch-count">${watch.count}</span>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        function updateQualityMetrics(sessions) {
            const emotionalSessions = sessions.filter(s => s.emotions_processed);
            
            // Average duration
            const avgDuration = sessions.length > 0 ? 
                sessions.reduce((sum, s) => sum + (s.duration_seconds || 0), 0) / sessions.length / 60 : 0;
            document.getElementById('avgDuration').textContent = avgDuration.toFixed(1);

            // Completion rate (sessions with >5 messages)
            const completedSessions = sessions.filter(s => (s.total_messages || 0) > 5).length;
            const completionRate = sessions.length > 0 ? (completedSessions / sessions.length * 100).toFixed(0) : '0';
            document.getElementById('completionRate').textContent = completionRate + '%';

            // Emotional depth (average emotions per session)
            const avgEmotionalDepth = emotionalSessions.length > 0 ?
                emotionalSessions.reduce((sum, s) => sum + (s.total_emotional_messages || 0), 0) / emotionalSessions.length : 0;
            document.getElementById('emotionalDepth').textContent = avgEmotionalDepth.toFixed(1);

            // Interaction quality (messages per minute)
            const avgInteractionQuality = sessions.length > 0 ?
                sessions.reduce((sum, s) => {
                    const duration = s.duration_seconds || 1;
                    return sum + ((s.total_messages || 0) / (duration / 60));
                }, 0) / sessions.length : 0;
            document.getElementById('interactionQuality').textContent = avgInteractionQuality.toFixed(1);
        }

        function updateTemporalPatterns(sessions) {
            const emotionalSessions = sessions.filter(s => s.emotions_processed && s.emotion_summary);
            
            if (emotionalSessions.length === 0) return;

            // Group by hour
            const hourlyData = {};
            emotionalSessions.forEach(session => {
                const hour = new Date(session.start_time).getHours();
                if (!hourlyData[hour]) {
                    hourlyData[hour] = { contemplation: [], interest: [], satisfaction: [], count: 0 };
                }
                
                const emotions = session.emotion_summary.average_emotions;
                if (emotions) {
                    hourlyData[hour].contemplation.push(emotions.Contemplation || 0);
                    hourlyData[hour].interest.push(emotions.Interest || 0);
                    hourlyData[hour].satisfaction.push(emotions.Satisfaction || 0);
                    hourlyData[hour].count++;
                }
            });

            // Prepare chart data
            const hours = Object.keys(hourlyData).sort((a, b) => parseInt(a) - parseInt(b));
            const contemplationData = hours.map(hour => {
                const values = hourlyData[hour].contemplation;
                return values.length > 0 ? (values.reduce((a, b) => a + b, 0) / values.length * 100).toFixed(1) : 0;
            });
            const interestData = hours.map(hour => {
                const values = hourlyData[hour].interest;
                return values.length > 0 ? (values.reduce((a, b) => a + b, 0) / values.length * 100).toFixed(1) : 0;
            });

            const ctx = document.getElementById('temporalChart').getContext('2d');
            
            if (temporalChart) {
                temporalChart.destroy();
            }

            temporalChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: hours.map(h => `${h}:00`),
                    datasets: [{
                        label: 'Contemplation',
                        data: contemplationData,
                        borderColor: '#d4af37',
                        backgroundColor: 'rgba(212, 175, 55, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Interest',
                        data: interestData,
                        borderColor: '#daa520',
                        backgroundColor: 'rgba(218, 165, 32, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateEmotionalJourney(sessions) {
            const emotionalSessions = sessions.filter(s => s.emotions_processed && s.emotion_summary)
                .sort((a, b) => new Date(a.start_time) - new Date(b.start_time));
            
            if (emotionalSessions.length === 0) return;

            // Prepare journey data
            const journeyData = emotionalSessions.map((session, index) => {
                const emotions = session.emotion_summary.average_emotions;
                return {
                    x: index + 1,
                    contemplation: (emotions.Contemplation || 0) * 100,
                    interest: (emotions.Interest || 0) * 100,
                    satisfaction: (emotions.Satisfaction || 0) * 100,
                    calmness: (emotions.Calmness || 0) * 100
                };
            });

            const ctx = document.getElementById('emotionalJourneyChart').getContext('2d');
            
            if (emotionalJourneyChart) {
                emotionalJourneyChart.destroy();
            }

            emotionalJourneyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: journeyData.map((_, i) => `Session ${i + 1}`),
                    datasets: [{
                        label: 'Contemplation',
                        data: journeyData.map(d => d.contemplation),
                        borderColor: '#d4af37',
                        backgroundColor: 'rgba(212, 175, 55, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Interest',
                        data: journeyData.map(d => d.interest),
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Satisfaction',
                        data: journeyData.map(d => d.satisfaction),
                        borderColor: '#27ae60',
                        backgroundColor: 'rgba(39, 174, 96, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Calmness',
                        data: journeyData.map(d => d.calmness),
                        borderColor: '#9b59b6',
                        backgroundColor: 'rgba(155, 89, 182, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        title: {
                            display: true,
                            text: 'Customer Emotional Journey Over Time'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        async function loadConversations() {
            const content = document.getElementById('conversationContent');
            content.innerHTML = '<div class="loading">Loading conversations...</div>';
            
            try {
                // Get filter values
                const dateFilter = document.getElementById('dateFilter').value;
                const messageType = document.getElementById('messageTypeFilter').value;
                const emotionFilter = document.getElementById('emotionFilter').value;
                const sessionId = document.getElementById('sessionIdFilter').value;
                const limit = document.getElementById('limitFilter').value;

                // Build query parameters
                const params = new URLSearchParams({
                    limit: limit,
                    include_emotions: 'true'
                });
                
                if (sessionId) params.set('session_id', sessionId);
                if (messageType !== 'all') params.set('message_type', messageType);
                if (dateFilter !== 'all') params.set('date_filter', dateFilter);
                if (emotionFilter !== 'all') params.set('emotion_filter', emotionFilter);

                const response = await fetch(`/api/conversations?${params}`);
                const data = await response.json();
                
                if (data.error) throw new Error(data.error);
                
                currentData = data.conversations;
                
                // Update summary stats
                updateConversationStats(currentData);
                
                // Build enhanced table
                if (currentData.length === 0) {
                    content.innerHTML = '<div class="loading">No conversations found with current filters.</div>';
                    return;
                }

                const table = document.createElement('table');
                table.className = 'conversation-table';
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Session</th>
                            <th>Type</th>
                            <th>Content</th>
                            <th>Words</th>
                            <th>Watch Model</th>
                            <th>Primary Emotion</th>
                            <th>Emotion Score</th>
                            <th>Emotional State</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${currentData.map(conv => {
                            const timestamp = new Date(conv.timestamp);
                            const content = conv.content.length > 50 ? 
                                conv.content.substring(0, 50) + '...' : conv.content;
                            
                            let topEmotion = '';
                            let emotionScore = '';
                            let emotionalState = '';
                            
                            if (conv.emotions && conv.message_type === 'user') {
                                const emotions = Object.entries(conv.emotions)
                                    .sort((a, b) => b[1] - a[1]);
                                if (emotions.length > 0) {
                                    const [emotion, score] = emotions[0];
                                    topEmotion = emotion;
                                    emotionScore = (score * 100).toFixed(1) + '%';
                                    
                                    // Determine emotional state
                                    if (score > 0.2) emotionalState = 'High';
                                    else if (score > 0.1) emotionalState = 'Medium';
                                    else emotionalState = 'Low';
                                }
                            }
                            
                            return `
                                <tr>
                                    <td>${timestamp.toLocaleString()}</td>
                                    <td>${conv.session_id.substring(0, 8)}...</td>
                                    <td><span class="message-type ${conv.message_type}-message">${conv.message_type}</span></td>
                                    <td title="${conv.content}">${content}</td>
                                    <td>${conv.word_count || 0}</td>
                                    <td>${conv.watch_model || '-'}</td>
                                    <td>${topEmotion || '-'}</td>
                                    <td>${emotionScore || '-'}</td>
                                    <td>${emotionalState ? `<span class="emotion-indicator">${emotionalState}</span>` : '-'}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                `;
                
                content.innerHTML = '';
                content.appendChild(table);
                
            } catch (error) {
                content.innerHTML = `<div class="error">‚ùå Error loading conversations: ${error.message}</div>`;
            }
        }

        function updateConversationStats(conversations) {
            // Total messages
            document.getElementById('filteredCount').textContent = conversations.length;
            
            // Unique sessions
            const uniqueSessions = new Set(conversations.map(c => c.session_id)).size;
            document.getElementById('uniqueSessions').textContent = uniqueSessions;
            
            // Average words per message
            const totalWords = conversations.reduce((sum, c) => sum + (c.word_count || 0), 0);
            const avgWords = conversations.length > 0 ? (totalWords / conversations.length).toFixed(1) : '0';
            document.getElementById('avgWordsPerMsg').textContent = avgWords;
            
            // Messages with emotions
            const emotionalMessages = conversations.filter(c => c.emotions && c.message_type === 'user').length;
            document.getElementById('emotionalMessages').textContent = emotionalMessages;
            
            // Average emotion intensity
            const emotionalConversations = conversations.filter(c => c.emotions && c.message_type === 'user');
            let avgIntensity = 0;
            if (emotionalConversations.length > 0) {
                const totalIntensity = emotionalConversations.reduce((sum, c) => {
                    const emotions = Object.values(c.emotions);
                    const maxEmotion = Math.max(...emotions);
                    return sum + maxEmotion;
                }, 0);
                avgIntensity = (totalIntensity / emotionalConversations.length * 100).toFixed(1);
            }
            document.getElementById('avgEmotionIntensity').textContent = avgIntensity + '%';
        }

        function exportData() {
            if (currentData.length === 0) {
                alert('No data to export. Please load conversations first.');
                return;
            }
            
            const csv = [
                ['Timestamp', 'Session ID', 'Message Type', 'Content', 'Word Count', 'Watch Model', 'Primary Emotion', 'Emotion Score', 'All Emotions', 'IP Address'],
                ...currentData.map(conv => {
                    let topEmotion = '';
                    let emotionScore = '';
                    let allEmotions = '';
                    
                    if (conv.emotions && conv.message_type === 'user') {
                        const emotions = Object.entries(conv.emotions).sort((a, b) => b[1] - a[1]);
                        if (emotions.length > 0) {
                            topEmotion = emotions[0][0];
                            emotionScore = (emotions[0][1] * 100).toFixed(2) + '%';
                            allEmotions = emotions.map(([e, s]) => `${e}:${(s*100).toFixed(1)}%`).join(';');
                        }
                    }
                    
                    return [
                        conv.timestamp,
                        conv.session_id,
                        conv.message_type,
                        conv.content.replace(/"/g, '""'), // Escape quotes
                        conv.word_count || 0,
                        conv.watch_model || '',
                        topEmotion,
                        emotionScore,
                        allEmotions,
                        conv.ip_address || ''
                    ];
                })
            ].map(row => row.map(field => `"${field}"`).join(',')).join('\n');
            
            downloadCSV(csv, `lorent_conversations_${new Date().toISOString().split('T')[0]}.csv`);
        }

        function exportEmotionalData() {
            if (currentSessions.length === 0) {
                alert('No session data available for export.');
                return;
            }

            const emotionalSessions = currentSessions.filter(s => s.emotions_processed && s.emotion_summary);
            
            if (emotionalSessions.length === 0) {
                alert('No emotional data available for export.');
                return;
            }

            const csv = [
                ['Session ID', 'Start Time', 'Duration (seconds)', 'Total Messages', 'Emotional Messages', 'Watch Models Shown', 
                 'Contemplation', 'Interest', 'Calmness', 'Concentration', 'Satisfaction', 'Awkwardness', 'Contentment', 
                 'Top Emotion 1', 'Top Score 1', 'Top Emotion 2', 'Top Score 2', 'Top Emotion 3', 'Top Score 3'],
                ...emotionalSessions.map(session => {
                    const emotions = session.emotion_summary.average_emotions;
                    const topEmotions = Object.entries(session.emotion_summary.top_emotions || {})
                        .sort((a, b) => b[1] - a[1]).slice(0, 3);
                    
                    return [
                        session.session_id,
                        session.start_time,
                        session.duration_seconds || 0,
                        session.total_messages || 0,
                        session.total_emotional_messages || 0,
                        (session.watch_models_shown || []).join(';'),
                        ((emotions.Contemplation || 0) * 100).toFixed(2),
                        ((emotions.Interest || 0) * 100).toFixed(2),
                        ((emotions.Calmness || 0) * 100).toFixed(2),
                        ((emotions.Concentration || 0) * 100).toFixed(2),
                        ((emotions.Satisfaction || 0) * 100).toFixed(2),
                        ((emotions.Awkwardness || 0) * 100).toFixed(2),
                        ((emotions.Contentment || 0) * 100).toFixed(2),
                        topEmotions[0] ? topEmotions[0][0] : '',
                        topEmotions[0] ? (topEmotions[0][1] * 100).toFixed(2) : '',
                        topEmotions[1] ? topEmotions[1][0] : '',
                        topEmotions[1] ? (topEmotions[1][1] * 100).toFixed(2) : '',
                        topEmotions[2] ? topEmotions[2][0] : '',
                        topEmotions[2] ? (topEmotions[2][1] * 100).toFixed(2) : ''
                    ];
                })
            ].map(row => row.map(field => `"${field}"`).join(',')).join('\n');
            
            downloadCSV(csv, `lorent_emotional_analysis_${new Date().toISOString().split('T')[0]}.csv`);
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', filename);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
