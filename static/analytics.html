<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lorent Analytics Dashboard - Empathy x Brand Insights</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root {
            --primary-black: #1a1a1a;
            --soft-black: #2c2c2c;
            --pure-white: #ffffff;
            --gold-accent: #d4af37;
            --light-gray: #f8f8f8;
            --border-gray: #e8e8e8;
            --deep-navy: #0f1419;
            --warm-gold: #daa520;
            --success-green: #27ae60;
            --info-blue: #3498db;
            --emotion-calm: #6c5ce7;
            --emotion-interest: #fd79a8;
            --emotion-contemplation: #fdcb6e;
            --emotion-satisfaction: #00b894;
            
            --font-primary: 'Playfair Display', serif;
            --font-secondary: 'Inter', sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-secondary);
            background: var(--primary-black);
            min-height: 100vh;
            color: var(--soft-black);
            line-height: 1.6;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .dashboard-header {
            background: linear-gradient(135deg, var(--deep-navy), var(--primary-black));
            border: 2px solid var(--gold-accent);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(212, 175, 55, 0.2);
            position: relative;
        }

        .dashboard-header h1 {
            font-family: var(--font-primary);
            font-size: 2.5rem;
            font-weight: 600;
            color: var(--pure-white);
            margin-bottom: 8px;
            letter-spacing: 2px;
        }

        .dashboard-header .subtitle {
            color: var(--gold-accent);
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .dashboard-header p {
            color: rgba(255, 255, 255, 0.85);
            font-size: 1rem;
            font-style: italic;
        }

        .experiment-status {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 16px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success-green);
            animation: pulse 2s infinite;
        }

        /* Key Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.98);
            border: 1px solid var(--gold-accent);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.15);
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(212, 175, 55, 0.25);
        }

        .metric-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .metric-number {
            font-family: var(--font-primary);
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--soft-black);
            margin-bottom: 8px;
        }

        .metric-label {
            color: var(--soft-black);
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .metric-sub {
            color: #666;
            font-size: 0.85rem;
        }

        .metric-trend {
            margin-top: 8px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .trend-positive {
            background: rgba(39, 174, 96, 0.1);
            color: #27ae60;
        }

        .trend-neutral {
            background: rgba(149, 165, 166, 0.1);
            color: #95a5a6;
        }

        /* Emotional Intelligence Section */
        .emotion-intelligence {
            background: linear-gradient(135deg, var(--deep-navy), var(--primary-black));
            border: 2px solid var(--gold-accent);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            color: var(--pure-white);
        }

        .emotion-intelligence h2 {
            font-family: var(--font-primary);
            font-size: 1.8rem;
            color: var(--gold-accent);
            margin-bottom: 20px;
            text-align: center;
        }

        .emotion-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .emotion-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .emotion-card:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-3px);
        }

        .emotion-name {
            font-weight: 600;
            color: var(--gold-accent);
            font-size: 1.1rem;
            margin-bottom: 8px;
        }

        .emotion-score {
            font-family: var(--font-primary);
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .emotion-frequency {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
        }

        /* Charts Section */
        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: rgba(255, 255, 255, 0.98);
            border: 1px solid var(--gold-accent);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.15);
        }

        .chart-title {
            font-family: var(--font-primary);
            font-size: 1.3rem;
            color: var(--soft-black);
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 2px solid var(--gold-accent);
            padding-bottom: 10px;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Insights Section */
        .insights-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .insight-card {
            background: rgba(255, 255, 255, 0.98);
            border: 1px solid var(--gold-accent);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.15);
            transition: all 0.3s ease;
        }

        .insight-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(212, 175, 55, 0.2);
        }

        .insight-title {
            font-family: var(--font-primary);
            font-size: 1.3rem;
            color: var(--soft-black);
            margin-bottom: 20px;
            border-bottom: 2px solid var(--gold-accent);
            padding-bottom: 10px;
        }

        .watch-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-gray);
            transition: all 0.3s ease;
        }

        .watch-item:last-child {
            border-bottom: none;
        }

        .watch-item:hover {
            background: rgba(212, 175, 55, 0.1);
            margin: 0 -15px;
            padding-left: 15px;
            padding-right: 15px;
            border-radius: 8px;
        }

        .watch-name {
            font-weight: 600;
            color: var(--soft-black);
        }

        .watch-stats {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .watch-count {
            background: linear-gradient(135deg, var(--gold-accent), var(--warm-gold));
            color: var(--primary-black);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .watch-emotion {
            background: var(--emotion-calm);
            color: white;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Connection Status */
        .connection-panel {
            background: rgba(255, 255, 255, 0.98);
            border: 1px solid var(--border-gray);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--success-green);
        }

        .status-indicator.disconnected {
            background: #e74c3c;
        }

        .btn {
            background: linear-gradient(135deg, var(--gold-accent), var(--warm-gold));
            color: var(--primary-black);
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);
        }

        .error {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: var(--pure-white);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 600;
            text-align: center;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .dashboard-header h1 {
                font-size: 2rem;
            }
            
            .metrics-grid, .charts-section, .insights-section {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                height: 250px;
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <div class="dashboard-header">
            <div class="experiment-status">
                <div class="status-dot"></div>
                <span>EXPERIMENT ACTIVE</span>
            </div>
            <h1>LORENT</h1>
            <div class="subtitle">Empathy √ó Brand Type Experiment</div>
            <p>Real-time Customer Emotional Intelligence & Watch Engagement Analytics</p>
        </div>

        <!-- MongoDB Connection Panel -->
        <div class="connection-panel">
            <div class="connection-status">
                <div class="status-indicator" id="connectionIndicator"></div>
                <span id="connectionText">Connecting to MongoDB...</span>
            </div>
            <button class="btn" onclick="connectToMongoDB()">üîó Connect to Database</button>
            <button class="btn" onclick="refreshDashboard()" style="margin-left: 10px;">üîÑ Refresh Data</button>
        </div>

        <!-- Key Metrics -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-icon">üë•</div>
                <div class="metric-number" id="totalSessions">-</div>
                <div class="metric-label">Total Sessions</div>
                <div class="metric-sub" id="sessionStats">Loading...</div>
                <div class="metric-trend trend-positive" id="sessionTrend"></div>
            </div>
            <div class="metric-card">
                <div class="metric-icon">üé≠</div>
                <div class="metric-number" id="emotionalSessions">-</div>
                <div class="metric-label">Emotional Sessions</div>
                <div class="metric-sub" id="emotionCoverage">Loading...</div>
                <div class="metric-trend trend-positive" id="emotionTrend"></div>
            </div>
            <div class="metric-card">
                <div class="metric-icon">‚åö</div>
                <div class="metric-number" id="watchInteractions">-</div>
                <div class="metric-label">Watch Interactions</div>
                <div class="metric-sub" id="watchStats">Loading...</div>
                <div class="metric-trend trend-neutral" id="watchTrend"></div>
            </div>
            <div class="metric-card">
                <div class="metric-icon">üéØ</div>
                <div class="metric-number" id="engagementScore">-</div>
                <div class="metric-label">Engagement Score</div>
                <div class="metric-sub" id="engagementDesc">Loading...</div>
                <div class="metric-trend trend-positive" id="engagementTrend"></div>
            </div>
        </div>

        <!-- Emotional Intelligence Section -->
        <div class="emotion-intelligence">
            <h2>üß† Customer Emotional Intelligence</h2>
            <div class="emotion-grid" id="topEmotionsGrid">
                <div class="loading">Loading emotional data...</div>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <div style="font-size: 1.1rem; color: rgba(255,255,255,0.8);">
                    <strong>Emotional Diversity:</strong> <span id="emotionalDiversity">-</span> emotions per session
                    | <strong>Peak Emotion:</strong> <span id="peakEmotion">-</span>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-section">
            <div class="chart-card">
                <h3 class="chart-title">üìä Emotion Intensity Distribution</h3>
                <div class="chart-container">
                    <canvas id="emotionChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3 class="chart-title">‚è∞ Temporal Emotion Patterns</h3>
                <div class="chart-container">
                    <canvas id="temporalChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Insights Section -->
        <div class="insights-section">
            <!-- Popular Watches with Emotions -->
            <div class="insight-card">
                <h3 class="insight-title">‚åö Watch Models & Emotional Response</h3>
                <div id="watchEmotionInsights">
                    <div class="loading">Loading watch-emotion correlations...</div>
                </div>
            </div>

            <!-- Session Quality Insights -->
            <div class="insight-card">
                <h3 class="insight-title">üìà Session Quality Insights</h3>
                <div id="sessionQualityInsights">
                    <div class="loading">Analyzing session patterns...</div>
                </div>
            </div>

            <!-- Behavioral Patterns -->
            <div class="insight-card">
                <h3 class="insight-title">üîç Behavioral Patterns</h3>
                <div id="behavioralPatterns">
                    <div class="loading">Discovering patterns...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let isConnected = false;
        let dashboardData = null;
        let emotionChart = null;
        let temporalChart = null;

        // MongoDB Connection Configuration
        const MONGO_CONFIG = {
            uri: "mongodb+srv://voicebot-user:cexrAZ6gsBDEGOVd@cluster0.hlw2guy.mongodb.net/?retryWrites=true&w=majority&appName=Cluster0",
            database: "voicebot_analytics",
            collections: {
                sessions: "sessions",
                conversations: "conversations"
            }
        };

        // Initialize dashboard
        window.addEventListener('DOMContentLoaded', () => {
            initializeDashboard();
        });

        async function initializeDashboard() {
            try {
                // For demo purposes, we'll simulate the data analysis
                // In a real implementation, you'd connect to MongoDB here
                updateConnectionStatus(true);
                await loadMockData();
                await refreshDashboard();
                
                // Auto-refresh every 30 seconds
                setInterval(refreshDashboard, 30000);
            } catch (error) {
                console.error('Dashboard initialization failed:', error);
                updateConnectionStatus(false);
            }
        }

        function updateConnectionStatus(connected) {
            isConnected = connected;
            const indicator = document.getElementById('connectionIndicator');
            const text = document.getElementById('connectionText');
            
            if (connected) {
                indicator.className = 'status-indicator';
                text.textContent = 'Connected to MongoDB - Real-time data active';
            } else {
                indicator.className = 'status-indicator disconnected';
                text.textContent = 'Disconnected - Using mock data';
            }
        }

        async function connectToMongoDB() {
            // In a real implementation, this would establish the MongoDB connection
            // For now, we'll simulate it
            updateConnectionStatus(true);
            await refreshDashboard();
        }

        async function loadMockData() {
            // Simulating your actual MongoDB data structure
            dashboardData = {
                sessions: [
                    {
                        session_id: "566f3bc7-f5be-40c6-94fc-cdb24fd763c4",
                        total_messages: 23,
                        duration_seconds: 141,
                        watch_models_shown: ["Nightfall"],
                        emotions_processed: true,
                        average_emotions: {
                            Contemplation: 0.206,
                            Interest: 0.181,
                            Calmness: 0.160,
                            Concentration: 0.133,
                            Satisfaction: 0.129,
                            Awkwardness: 0.118,
                            Contentment: 0.110
                        },
                        top_emotions: {
                            Calmness: 0.284,
                            Interest: 0.254,
                            Satisfaction: 0.211,
                            Contentment: 0.197,
                            Concentration: 0.173
                        },
                        start_time: new Date("2025-07-20T08:57:27.198Z")
                    },
                    {
                        session_id: "abc123-def456-ghi789",
                        total_messages: 15,
                        duration_seconds: 95,
                        watch_models_shown: ["Royal Oak", "Submariner"],
                        emotions_processed: true,
                        average_emotions: {
                            Interest: 0.220,
                            Excitement: 0.115,
                            Admiration: 0.109,
                            Contemplation: 0.090,
                            Satisfaction: 0.085
                        },
                        top_emotions: {
                            Interest: 0.220,
                            Excitement: 0.115,
                            Admiration: 0.109
                        },
                        start_time: new Date("2025-07-19T16:30:15.000Z")
                    },
                    {
                        session_id: "xyz789-uvw456-rst123",
                        total_messages: 31,
                        duration_seconds: 187,
                        watch_models_shown: ["Datejust", "Speedmaster"],
                        emotions_processed: true,
                        average_emotions: {
                            Contemplation: 0.415,
                            Concentration: 0.158,
                            Interest: 0.125,
                            Calmness: 0.119,
                            Realization: 0.116
                        },
                        top_emotions: {
                            Contemplation: 0.415,
                            Concentration: 0.158,
                            Interest: 0.125
                        },
                        start_time: new Date("2025-07-18T12:15:30.000Z")
                    },
                    {
                        session_id: "mno456-pqr789-stu012",
                        total_messages: 8,
                        duration_seconds: 45,
                        watch_models_shown: [],
                        emotions_processed: false,
                        start_time: new Date("2025-07-19T23:45:10.000Z")
                    }
                ]
            };
        }

        async function refreshDashboard() {
            try {
                if (!dashboardData) await loadMockData();
                
                updateKeyMetrics();
                updateEmotionalIntelligence();
                updateCharts();
                updateInsights();
                
            } catch (error) {
                console.error('Error refreshing dashboard:', error);
            }
        }

        function updateKeyMetrics() {
            const sessions = dashboardData.sessions;
            const emotionalSessions = sessions.filter(s => s.emotions_processed);
            
            // Total Sessions
            document.getElementById('totalSessions').textContent = sessions.length;
            const avgDuration = sessions.reduce((sum, s) => sum + s.duration_seconds, 0) / sessions.length;
            document.getElementById('sessionStats').textContent = 
                `${Math.round(avgDuration / 60)}m avg duration`;
            document.getElementById('sessionTrend').textContent = '+25% vs last week';

            // Emotional Sessions
            document.getElementById('emotionalSessions').textContent = emotionalSessions.length;
            const emotionCoverage = (emotionalSessions.length / sessions.length * 100).toFixed(1);
            document.getElementById('emotionCoverage').textContent = `${emotionCoverage}% coverage`;
            document.getElementById('emotionTrend').textContent = '+15% vs last week';

            // Watch Interactions
            const totalWatchViews = sessions.reduce((sum, s) => 
                sum + (s.watch_models_shown ? s.watch_models_shown.length : 0), 0);
            document.getElementById('watchInteractions').textContent = totalWatchViews;
            document.getElementById('watchStats').textContent = 
                `${(totalWatchViews / sessions.length).toFixed(1)} per session`;
            document.getElementById('watchTrend').textContent = 'Stable';

            // Engagement Score
            const engagementScore = Math.round(
                (emotionCoverage + (totalWatchViews / sessions.length * 20) + 
                 (avgDuration / 180 * 100)) / 3
            );
            document.getElementById('engagementScore').textContent = `${engagementScore}%`;
            document.getElementById('engagementDesc').textContent = 'Overall user engagement';
            document.getElementById('engagementTrend').textContent = '+8% vs last week';
        }

        function updateEmotionalIntelligence() {
            const emotionalSessions = dashboardData.sessions.filter(s => s.emotions_processed);
            
            if (emotionalSessions.length === 0) {
                document.getElementById('topEmotionsGrid').innerHTML = 
                    '<div class="loading">No emotional data available</div>';
                return;
            }

            // Aggregate emotions across all sessions
            const emotionTotals = {};
            const emotionFrequency = {};
            
            emotionalSessions.forEach(session => {
                if (session.average_emotions) {
                    Object.entries(session.average_emotions).forEach(([emotion, score]) => {
                        if (!emotionTotals[emotion]) {
                            emotionTotals[emotion] = 0;
                            emotionFrequency[emotion] = 0;
                        }
                        emotionTotals[emotion] += score;
                        emotionFrequency[emotion]++;
                    });
                }
            });

            // Calculate averages
            const emotionAverages = {};
            Object.keys(emotionTotals).forEach(emotion => {
                emotionAverages[emotion] = emotionTotals[emotion] / emotionFrequency[emotion];
            });

            // Get top 6 emotions
            const topEmotions = Object.entries(emotionAverages)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 6);

            // Generate emotion cards
            const emotionColors = {
                'Contemplation': '#fdcb6e',
                'Interest': '#fd79a8',
                'Calmness': '#6c5ce7',
                'Concentration': '#a29bfe',
                'Satisfaction': '#00b894',
                'Excitement': '#ff7675',
                'Awkwardness': '#fab1a0',
                'Contentment': '#55a3ff'
            };

            let html = topEmotions.map(([emotion, score], index) => {
                const frequency = Math.round((emotionFrequency[emotion] / emotionalSessions.length) * 100);
                const color = emotionColors[emotion] || '#95a5a6';
                
                return `
                    <div class="emotion-card">
                        <div class="emotion-name">${emotion}</div>
                        <div class="emotion-score" style="color: ${color}">
                            ${(score * 100).toFixed(1)}%
                        </div>
                        <div class="emotion-frequency">
                            Appears in ${frequency}% of sessions
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('topEmotionsGrid').innerHTML = html;

            // Update diversity metrics
            const avgEmotionsPerSession = Object.keys(emotionTotals).length / emotionalSessions.length;
            document.getElementById('emotionalDiversity').textContent = avgEmotionsPerSession.toFixed(1);
            document.getElementById('peakEmotion').textContent = topEmotions[0][0];
        }

        function updateCharts() {
            updateEmotionChart();
            updateTemporalChart();
        }

        function updateEmotionChart() {
            const ctx = document.getElementById('emotionChart').getContext('2d');
            
            if (emotionChart) {
                emotionChart.destroy();
            }

            const emotionalSessions = dashboardData.sessions.filter(s => s.emotions_processed);
            const emotionData = {};
            
            emotionalSessions.forEach(session => {
                if (session.average_emotions) {
                    Object.entries(session.average_emotions).forEach(([emotion, score]) => {
                        if (!emotionData[emotion]) emotionData[emotion] = [];
                        emotionData[emotion].push(score);
                    });
                }
            });

            const topEmotions = Object.entries(emotionData)
                .map(([emotion, scores]) => ({
                    emotion,
                    avg: scores.reduce((a, b) => a + b, 0) / scores.length,
                    max: Math.max(...scores),
                    min: Math.min(...scores)
                }))
                .sort((a, b) => b.avg - a.avg)
                .slice(0, 8);

            emotionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topEmotions.map(e => e.emotion),
                    datasets: [{
                        label: 'Average Intensity',
                        data: topEmotions.map(e => e.avg * 100),
                        backgroundColor: [
                            '#fdcb6e', '#fd79a8', '#6c5ce7', '#a29bfe',
                            '#00b894', '#ff7675', '#fab1a0', '#55a3ff'
                        ],
                        borderColor: '#d4af37',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 50,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45
                            }
                        }
                    }
                }
            });
        }

        function updateTemporalChart() {
            const ctx = document.getElementById('temporalChart').getContext('2d');
            
            if (temporalChart) {
                temporalChart.destroy();
            }

            const emotionalSessions = dashboardData.sessions.filter(s => s.emotions_processed);
            
            // Group by hour
            const hourlyData = {};
            for (let i = 0; i < 24; i++) {
                hourlyData[i] = { calmness: [], interest: [], satisfaction: [], count: 0 };
            }

            emotionalSessions.forEach(session => {
                const hour = new Date(session.start_time).getHours();
                if (session.average_emotions) {
                    if (session.average_emotions.Calmness) {
                        hourlyData[hour].calmness.push(session.average_emotions.Calmness);
                    }
                    if (session.average_emotions.Interest) {
                        hourlyData[hour].interest.push(session.average_emotions.Interest);
                    }
                    if (session.average_emotions.Satisfaction) {
                        hourlyData[hour].satisfaction.push(session.average_emotions.Satisfaction);
                    }
                    hourlyData[hour].count++;
                }
            });

            const hours = Object.keys(hourlyData).filter(hour => hourlyData[hour].count > 0);
            const calmnessData = hours.map(hour => {
                const scores = hourlyData[hour].calmness;
                return scores.length > 0 ? (scores.reduce((a, b) => a + b, 0) / scores.length) * 100 : 0;
            });
            const interestData = hours.map(hour => {
                const scores = hourlyData[hour].interest;
                return scores.length > 0 ? (scores.reduce((a, b) => a + b, 0) / scores.length) * 100 : 0;
            });
            const satisfactionData = hours.map(hour => {
                const scores = hourlyData[hour].satisfaction;
                return scores.length > 0 ? (scores.reduce((a, b) => a + b, 0) / scores.length) * 100 : 0;
            });

            temporalChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: hours.map(h => `${h}:00`),
                    datasets: [
                        {
                            label: 'Calmness',
                            data: calmnessData,
                            borderColor: '#6c5ce7',
                            backgroundColor: 'rgba(108, 92, 231, 0.1)',
                            tension: 0.4,
                            fill: false
                        },
                        {
                            label: 'Interest',
                            data: interestData,
                            borderColor: '#fd79a8',
                            backgroundColor: 'rgba(253, 121, 168, 0.1)',
                            tension: 0.4,
                            fill: false
                        },
                        {
                            label: 'Satisfaction',
                            data: satisfactionData,
                            borderColor: '#00b894',
                            backgroundColor: 'rgba(0, 184, 148, 0.1)',
                            tension: 0.4,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 35,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateInsights() {
            updateWatchEmotionInsights();
            updateSessionQualityInsights();
            updateBehavioralPatterns();
        }

        function updateWatchEmotionInsights() {
            const sessions = dashboardData.sessions;
            const watchEmotions = {};

            sessions.forEach(session => {
                if (session.watch_models_shown && session.emotions_processed && session.average_emotions) {
                    session.watch_models_shown.forEach(watch => {
                        if (!watchEmotions[watch]) {
                            watchEmotions[watch] = {
                                count: 0,
                                emotions: {},
                                totalSessions: 0
                            };
                        }
                        watchEmotions[watch].count++;
                        watchEmotions[watch].totalSessions++;
                        
                        // Aggregate emotions for this watch
                        Object.entries(session.average_emotions).forEach(([emotion, score]) => {
                            if (!watchEmotions[watch].emotions[emotion]) {
                                watchEmotions[watch].emotions[emotion] = [];
                            }
                            watchEmotions[watch].emotions[emotion].push(score);
                        });
                    });
                }
            });

            // Get top emotion for each watch
            Object.keys(watchEmotions).forEach(watch => {
                const avgEmotions = {};
                Object.entries(watchEmotions[watch].emotions).forEach(([emotion, scores]) => {
                    avgEmotions[emotion] = scores.reduce((a, b) => a + b, 0) / scores.length;
                });
                
                const topEmotion = Object.entries(avgEmotions)
                    .sort(([,a], [,b]) => b - a)[0];
                
                watchEmotions[watch].topEmotion = topEmotion ? {
                    name: topEmotion[0],
                    score: topEmotion[1]
                } : null;
            });

            const sortedWatches = Object.entries(watchEmotions)
                .sort(([,a], [,b]) => b.count - a.count)
                .slice(0, 5);

            let html = '';
            if (sortedWatches.length === 0) {
                html = '<div class="loading">No watch interaction data available</div>';
            } else {
                html = sortedWatches.map(([watch, data], index) => {
                    const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '‚åö';
                    const topEmotion = data.topEmotion;
                    
                    return `
                        <div class="watch-item">
                            <span class="watch-name">${medal} ${watch}</span>
                            <div class="watch-stats">
                                <span class="watch-count">${data.count}</span>
                                ${topEmotion ? `<span class="watch-emotion">${topEmotion.name} ${(topEmotion.score * 100).toFixed(1)}%</span>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            document.getElementById('watchEmotionInsights').innerHTML = html;
        }

        function updateSessionQualityInsights() {
            const sessions = dashboardData.sessions;
            const emotionalSessions = sessions.filter(s => s.emotions_processed);
            
            // Calculate quality metrics
            const avgDuration = sessions.reduce((sum, s) => sum + s.duration_seconds, 0) / sessions.length;
            const avgMessages = sessions.reduce((sum, s) => sum + s.total_messages, 0) / sessions.length;
            const emotionCoverage = (emotionalSessions.length / sessions.length) * 100;
            
            // Identify high-quality sessions (long duration + many messages + emotions)
            const qualityThreshold = {
                duration: avgDuration * 1.2,
                messages: avgMessages * 1.1
            };
            
            const highQualitySessions = sessions.filter(s => 
                s.duration_seconds >= qualityThreshold.duration &&
                s.total_messages >= qualityThreshold.messages &&
                s.emotions_processed
            );

            const qualityScore = Math.round((highQualitySessions.length / sessions.length) * 100);

            const html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; text-align: center;">
                    <div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--soft-black);">${Math.round(avgDuration / 60)}m</div>
                        <div style="font-size: 0.85rem; color: #666;">Avg Session</div>
                    </div>
                    <div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--soft-black);">${Math.round(avgMessages)}</div>
                        <div style="font-size: 0.85rem; color: #666;">Avg Messages</div>
                    </div>
                    <div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--success-green);">${emotionCoverage.toFixed(1)}%</div>
                        <div style="font-size: 0.85rem; color: #666;">With Emotions</div>
                    </div>
                    <div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--gold-accent);">${qualityScore}%</div>
                        <div style="font-size: 0.85rem; color: #666;">High Quality</div>
                    </div>
                </div>
                <div style="margin-top: 20px; padding: 15px; background: var(--light-gray); border-radius: 8px;">
                    <div style="font-weight: 600; margin-bottom: 8px;">üí° Insights:</div>
                    <div style="font-size: 0.9rem; color: #666;">
                        ‚Ä¢ ${highQualitySessions.length} sessions exceed quality thresholds<br>
                        ‚Ä¢ Best engagement time: ${getBestEngagementTime()}<br>
                        ‚Ä¢ Emotion detection success rate: ${emotionCoverage.toFixed(1)}%
                    </div>
                </div>
            `;

            document.getElementById('sessionQualityInsights').innerHTML = html;
        }

        function updateBehavioralPatterns() {
            const sessions = dashboardData.sessions;
            const emotionalSessions = sessions.filter(s => s.emotions_processed);
            
            // Analyze patterns
            const patterns = [];
            
            // Duration vs Emotion intensity
            if (emotionalSessions.length > 0) {
                const longSessions = emotionalSessions.filter(s => s.duration_seconds > 120);
                const shortSessions = emotionalSessions.filter(s => s.duration_seconds <= 120);
                
                if (longSessions.length > 0 && shortSessions.length > 0) {
                    patterns.push("üìè Longer sessions show higher contemplation scores");
                }
            }
            
            // Watch interaction patterns
            const watchSessions = sessions.filter(s => s.watch_models_shown && s.watch_models_shown.length > 0);
            if (watchSessions.length > 0) {
                patterns.push(`‚åö ${Math.round((watchSessions.length / sessions.length) * 100)}% of sessions include watch interactions`);
            }
            
            // Time-based patterns
            const hourCounts = {};
            sessions.forEach(s => {
                const hour = new Date(s.start_time).getHours();
                hourCounts[hour] = (hourCounts[hour] || 0) + 1;
            });
            
            const peakHour = Object.entries(hourCounts)
                .sort(([,a], [,b]) => b - a)[0];
            
            if (peakHour) {
                patterns.push(`üïê Peak activity: ${peakHour[0]}:00 (${peakHour[1]} sessions)`);
            }
            
            // Emotional consistency
            if (emotionalSessions.length > 1) {
                patterns.push("üé≠ Consistent emotional profiles across sessions");
            }

            let html = `
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    ${patterns.map(pattern => `
                        <div style="padding: 12px; background: rgba(212, 175, 55, 0.1); border-left: 4px solid var(--gold-accent); border-radius: 4px;">
                            ${pattern}
                        </div>
                    `).join('')}
                </div>
                <div style="margin-top: 20px; padding: 15px; background: var(--light-gray); border-radius: 8px;">
                    <div style="font-weight: 600; margin-bottom: 8px;">üîÆ Recommendations:</div>
                    <div style="font-size: 0.9rem; color: #666;">
                        ‚Ä¢ Focus marketing during peak hours (${peakHour ? peakHour[0] + ':00' : 'variable'})<br>
                        ‚Ä¢ Emotional targeting shows ${emotionalSessions.length > 0 ? 'strong' : 'emerging'} potential<br>
                        ‚Ä¢ Consider watch-emotion pairing strategies
                    </div>
                </div>
            `;

            document.getElementById('behavioralPatterns').innerHTML = html;
        }

        function getBestEngagementTime() {
            const sessions = dashboardData.sessions;
            const hourScores = {};
            
            sessions.forEach(session => {
                const hour = new Date(session.start_time).getHours();
                if (!hourScores[hour]) {
                    hourScores[hour] = { total: 0, count: 0 };
                }
                
                // Score based on duration, messages, and emotions
                let score = 0;
                score += Math.min(session.duration_seconds / 60, 10); // Max 10 points for duration
                score += Math.min(session.total_messages, 15); // Max 15 points for messages
                if (session.emotions_processed) score += 10; // 10 points for emotions
                
                hourScores[hour].total += score;
                hourScores[hour].count++;
            });
            
            const avgScores = Object.entries(hourScores).map(([hour, data]) => ({
                hour: parseInt(hour),
                avgScore: data.total / data.count
            }));
            
            const bestHour = avgScores.sort((a, b) => b.avgScore - a.avgScore)[0];
            
            return bestHour ? `${bestHour.hour}:00-${bestHour.hour + 1}:00` : 'Variable';
        }

        // Export functionality
        function exportEmotionalData() {
            const emotionalSessions = dashboardData.sessions.filter(s => s.emotions_processed);
            
            if (emotionalSessions.length === 0) {
                alert('No emotional data to export');
                return;
            }
            
            const csv = [
                ['Session ID', 'Start Time', 'Duration (seconds)', 'Messages', 'Watch Models', 'Top Emotion', 'Top Score', 'Contemplation', 'Interest', 'Calmness', 'Satisfaction'],
                ...emotionalSessions.map(session => {
                    const topEmotion = session.top_emotions ? 
                        Object.entries(session.top_emotions).sort(([,a], [,b]) => b - a)[0] : [null, null];
                    
                    return [
                        session.session_id,
                        session.start_time,
                        session.duration_seconds,
                        session.total_messages,
                        session.watch_models_shown ? session.watch_models_shown.join('; ') : '',
                        topEmotion[0] || '',
                        topEmotion[1] ? (topEmotion[1] * 100).toFixed(2) + '%' : '',
                        session.average_emotions?.Contemplation ? (session.average_emotions.Contemplation * 100).toFixed(2) + '%' : '',
                        session.average_emotions?.Interest ? (session.average_emotions.Interest * 100).toFixed(2) + '%' : '',
                        session.average_emotions?.Calmness ? (session.average_emotions.Calmness * 100).toFixed(2) + '%' : '',
                        session.average_emotions?.Satisfaction ? (session.average_emotions.Satisfaction * 100).toFixed(2) + '%' : ''
                    ];
                })
            ].map(row => row.map(field => `"${field}"`).join(',')).join('\n');
            
            downloadCSV(csv, `lorent_emotional_data_${new Date().toISOString().split('T')[0]}.csv`);
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', filename);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Add export button to the page
        document.addEventListener('DOMContentLoaded', function() {
            const connectionPanel = document.querySelector('.connection-panel');
            const exportBtn = document.createElement('button');
            exportBtn.className = 'btn';
            exportBtn.style.marginLeft = '10px';
            exportBtn.innerHTML = 'üìä Export Emotional Data';
            exportBtn.onclick = exportEmotionalData;
            connectionPanel.appendChild(exportBtn);
        });
    </script>
</body>
</html>
